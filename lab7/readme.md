# Документация по интерфейсам и алгоритмам для lab5

## 220 — Архитектура

### Общая схема
- Клиент: статический фронтенд на HTML/CSS/JS (папка `lab5/frontend`).
- Сервер: FastAPI приложение (файл `lab5/app/main.py`).
- База данных: SQLite файл `lab5/app/social.db`.
- Файлы загрузок: директория `lab5/uploads`, раздается как `/uploads/*`.

### Потоки данных
1. Браузер загружает HTML из FastAPI (роуты `/`, `/login`, `/register`, `/posts/new`, `/posts/{id}/edit`, `/post/{id}`).
2. JS в браузере обращается к API через `fetch`.
3. FastAPI валидирует, работает с SQLite и возвращает JSON.
4. При загрузке изображений сервер сохраняет файл и возвращает URL вида `/uploads/имя_файла`.

### Основные компоненты
- **API слой**: маршруты FastAPI.
- **Сервисный слой**: функции в `main.py` для хеширования, токенов, работы с БД, сохранения файлов.
- **Хранилище**: SQLite таблицы `users`, `posts`, `comments`, `likes`, `media`, `sessions`.
- **UI слой**: страницы и скрипты фронтенда.

### Модель данных (кратко)
- `users`: имя, email, хеш пароля, аватар, дата создания.
- `posts`: автор, текст, изображение, даты создания/обновления.
- `comments`: пост, автор, текст, дата.
- `likes`: пост, пользователь, дата.
- `media`: связь загруженных файлов с пользователем или постом.
- `sessions`: токен сессии и пользователь.

## 230 — Сервисы

### Аутентификация
- **POST `/auth/register`**: регистрация пользователя. Создает запись в `users` и `sessions`, возвращает токен.
- **POST `/auth/login`**: проверка email/пароля, создание новой сессии, возвращает токен.
- Токен хранится в `localStorage` и передается в `Authorization: Bearer <token>`.

### Пользователь
- **GET `/users/me`**: возвращает профиль текущего пользователя.
- **PUT `/users/me/avatar`**: загрузка нового аватара (multipart). Сохраняет файл и обновляет `avatar_url`.

### Посты
- **POST `/posts`**: создание поста (multipart: `text`, `image`).
- **PUT `/posts/{id}`**: обновление текста и изображения. Поддержка удаления картинки (`remove_image=1`).
- **DELETE `/posts/{id}`**: удаление поста (только автор).
- **GET `/posts/{id}`**: детальная информация о посте + комментарии + признак `liked_by_me`.

### Лента
- **GET `/feed?limit=20&offset=0`**: список постов с авторами, количеством лайков и комментариев.
- Если пользователь авторизован — возвращает `liked_by_me`.

### Комментарии и лайки
- **POST `/posts/{id}/comments`**: добавление комментария (только авторизованные).
- **POST `/posts/{id}/like`**: поставить лайк.
- **DELETE `/posts/{id}/like`**: снять лайк.

### Медиа
- **GET `/media/{filename}`** и `/uploads/{filename}`: раздача загруженных файлов.

### Алгоритмы и правила
- **Хеш пароля**: SHA-256 от `salt + password`, хранится как `salt$hash`.
- **Токен сессии**: SHA-256 от строки `user_id:random:timestamp:SECRET`.
- **Проверка токена**: поиск в таблице `sessions` и связанного пользователя.
- **Валидация**:
  - email уникален, пароль минимум 6 символов.
  - текст поста/комментария не пустой.
  - изображение только из расширений `jpg/jpeg/png/gif/webp`.
- **Feed**: запрос с `JOIN` и подзапросами на подсчет лайков/комментариев, сортировка по `created_at DESC`.
- **Комментарии**: сортировка по возрастанию времени.
- **Доступ**: редактирование/удаление поста доступно только автору.

## 240 — UI

### Страницы
- **`/`**: основная лента + профиль пользователя + панель подробностей поста.
- **`/login`**: форма входа.
- **`/register`**: форма регистрации.
- **`/posts/new`**: создание поста.
- **`/posts/{id}/edit`**: редактирование поста.
- **`/post/{id}`**: детальный просмотр (реиспользует главную страницу).

### Основные элементы интерфейса
- **Профиль**: имя, email, аватар, статус сессии.
- **Лента**: карточки постов, кнопки открыть, лайк, комментарии.
- **Деталь поста**: текст, изображение, лайки, комментарии, кнопки редактировать/удалить для автора.
- **Редактор**: textarea, загрузка изображения, предпросмотр, кнопки сохранить/удалить.
- **Тосты**: уведомления об ошибках и статусе операций.

### Поведение UI (ключевые сценарии)
- **Авторизация**: после логина/регистрации токен сохраняется в `localStorage`, UI обновляет профиль и ленту.
- **Загрузка ленты**: `loadFeed()` получает данные из `/feed`, строит карточки постов.
- **Открытие поста**: `openPost(id)` получает детальные данные и комментарии.
- **Лайк/анлайк**: переключение состояния, обновление деталей и ленты.
- **Комментарий**: отправка формы, перезагрузка деталей и ленты.
- **Редактор**: определение режима (`new` или `edit`) по URL, подгрузка поста для редактирования.
- **Превью изображения**: `FileReader` показывает миниатюру и размер файла; удаление изображения устанавливает `remove_image=1`.

### Визуальные акценты
- Единый стиль карточек, мягкие тени и скругления.
- Фоновые декоративные элементы (`bg-orb`).
- Анимация появления элементов ленты (staggered effect).

---
Документация сформирована на основе исходников lab5.
